<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智慧測驗</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2em;
      transition: background-color 0.3s, color 0.3s;
    }
    body.day-theme { background-color: #ffffff; color: #000000; }
    body.night-theme { background-color: #1a1a1a; color: #f0f0f0; }
    .question-card {
      background: inherit;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: auto;
    }
    .option-btn {
      display: block;
      margin: 0.5em 0;
      padding: 1em;
      width: 100%;
      font-size: 1.1em;
    }
    .correct { color: green; }
    .incorrect { color: red; }
    #next-btn, #retry-btn, #clear-btn, #reshuffle-btn, #show-result-btn {
      margin-top: 1em;
      padding: 0.6em 1em;
      font-size: 1em;
    }
    #progress {
      position: fixed;
      top: 1em;
      right: 1em;
      font-size: 0.9em;
      background: rgba(0,0,0,0.05);
      padding: 0.4em 0.8em;
      border-radius: 6px;
    }
    footer {
      margin-top: 2em;
      text-align: center;
      font-size: 0.85em;
      color: gray;
    }
  </style>
</head>
<body>
  <div id="progress"></div>
  <button id="toggle-theme-btn">🌗 切換主題</button>
  <button id="clear-btn">🔄 清除紀錄</button>
  <button id="reshuffle-btn">🎲 重出題</button>
  <button id="show-result-btn">📊 立即看結果</button>

  <h2>智慧測驗系統</h2>
  <div id="quiz-container"></div>
  <div style="text-align: center;">
    <button id="next-btn" style="display:none">下一題</button>
  </div>
  <button id="retry-btn" style="display:none">🔁 重練錯題</button>

  <footer id="footer-msg">題庫於 2025.08.12 更新 30 題</footer>

  <script>
    // ========== 主題切換 ==========
    const hour = new Date().getHours();
    document.body.classList.add(hour >= 6 && hour < 18 ? "day-theme" : "night-theme");
    document.getElementById("toggle-theme-btn").onclick = () => {
      document.body.classList.toggle("day-theme");
      document.body.classList.toggle("night-theme");
    };

    // ========== 題庫與狀態 ==========
    let allQuestions = [];
    let quizQuestions = [];
    let seenIds = JSON.parse(localStorage.getItem("seenQuestions") || "[]");
    const quizCount = 50;

    const container = document.getElementById("quiz-container");
    const nextBtn = document.getElementById("next-btn");
    const retryBtn = document.getElementById("retry-btn");
    const clearBtn = document.getElementById("clear-btn");
    const reshuffleBtn = document.getElementById("reshuffle-btn");
    const showResultBtn = document.getElementById("show-result-btn");

    let currentQuestionIndex = 0;
    let score = 0;
    let wrongList = [];

    function updateProgressDisplay() {
      const total = allQuestions.length;
      const seen = JSON.parse(localStorage.getItem("seenQuestions") || "[]").length;
      document.getElementById("progress").innerText = `已作答 ${seen} / ${total}`;
    }

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function showQuestion(index) {
      updateProgressDisplay();
      container.innerHTML = "";
      nextBtn.style.display = "none";
      retryBtn.style.display = "none";

      const q = quizQuestions[index];
      const card = document.createElement("div");
      card.className = "question-card";

      const title = document.createElement("h3");
      title.innerText = `題目 ${index + 1}: ${q.question}`;
      card.appendChild(title);

      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerText = opt;
        btn.onclick = () => {
          const correct = (i === q.answer);
          btn.classList.add(correct ? "correct" : "incorrect");
          btn.innerText += correct ? " ✅ 正確！" : ` ❌ 錯誤，正解是：${q.options[q.answer]}`;
          card.querySelectorAll("button").forEach(b => b.disabled = true);
          if (!correct) wrongList.push(q);
          if (correct) score++;
          nextBtn.style.display = "inline-block";
        };
        card.appendChild(btn);
      });

      container.appendChild(card);
    }

    nextBtn.onclick = () => {
      const qid = quizQuestions[currentQuestionIndex].id;
      if (!seenIds.includes(qid)) {
        seenIds.push(qid);
        localStorage.setItem("seenQuestions", JSON.stringify(seenIds));
      }
      updateProgressDisplay();

      currentQuestionIndex++;
      if (currentQuestionIndex < quizQuestions.length) {
        showQuestion(currentQuestionIndex);
      } else {
        showResult();
      }
    };

    function showResult() {
      updateProgressDisplay();
      let html = `<div class="question-card">
        <h3>✅ 測驗完成</h3>
        <p>你答對了 ${score} / ${currentQuestionIndex} 題</p>`;

      if (wrongList.length > 0) {
        html += "<hr><h4>❌ 錯題複習：</h4><ul>";
        wrongList.forEach(w => {
          html += `<li>${w.question}<br><small>正確答案：${w.options[w.answer]}</small></li>`;
        });
        html += "</ul>";
      }

      html += "</div>";
      container.innerHTML = html;
      if (wrongList.length > 0) retryBtn.style.display = "inline-block";
    }

    retryBtn.onclick = () => {
      quizQuestions = shuffle(wrongList);
      wrongList = [];
      currentQuestionIndex = 0;
      score = 0;
      showQuestion(0);
    };

    clearBtn.onclick = () => {
      localStorage.removeItem("seenQuestions");
      location.reload();
    };

    // 🎲 重出題（不清除紀錄）
    reshuffleBtn.onclick = () => {
      const unusedQuestions = allQuestions.filter(q => !seenIds.includes(q.id));
      quizQuestions = shuffle([...unusedQuestions]).slice(0, quizCount);
      currentQuestionIndex = 0;
      score = 0;
      wrongList = [];
      showQuestion(0);
    };

    // 📊 即時顯示結果
    showResultBtn.onclick = () => {
      showResult();
    };

    // ========== 載入外部 JSON 題庫 ==========
    fetch("questions.json")
      .then(response => response.json())
      .then(data => {
        allQuestions = data;
        seenIds = JSON.parse(localStorage.getItem("seenQuestions") || "[]");
        const unusedQuestions = allQuestions.filter(q => !seenIds.includes(q.id));
        quizQuestions = shuffle([...unusedQuestions]).slice(0, quizCount);

        if (quizQuestions.length > 0) {
          showQuestion(0);
        } else {
          updateProgressDisplay();
          container.innerHTML = "<p>🎉 你已完成所有題目！請點『清除紀錄』以重做。</p>";
        }
      })
      .catch(err => {
        container.innerHTML = `<p>❌ 題庫載入失敗：${err}</p>`;
      });
  </script>
</body>
</html>
